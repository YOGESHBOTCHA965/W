<section class="forgot-page">
  <!-- Background Decorations -->
  <div class="bg-decoration">
    <div class="bg-circle bg-circle-1"></div>
    <div class="bg-circle bg-circle-2"></div>
  </div>

  <div class="forgot-container animate-fadeInUp">
    <div class="forgot-card glass">
      <!-- Brand Header -->
      <div class="forgot-header">
        <div class="forgot-brand">
          <div class="brand-icon">
            <i class="fas fa-gear"></i>
          </div>
          <span class="brand-text">W<span class="text-gradient">O</span>W</span>
        </div>
        <h2 class="forgot-title">Reset Password</h2>
        <p class="forgot-subtitle">
          <span *ngIf="step === 1">Enter your registered email to get started</span>
          <span *ngIf="step === 2">Verify your identity</span>
          <span *ngIf="step === 3">Create a new password</span>
        </p>
      </div>

      <!-- Progress Steps -->
      <div class="step-indicators">
        <div class="step-dot" [class.active]="step >= 1" [class.done]="step > 1">
          <span *ngIf="step <= 1">1</span>
          <i *ngIf="step > 1" class="fas fa-check"></i>
        </div>
        <div class="step-line" [class.active]="step >= 2"></div>
        <div class="step-dot" [class.active]="step >= 2" [class.done]="step > 2">
          <span *ngIf="step <= 2">2</span>
          <i *ngIf="step > 2" class="fas fa-check"></i>
        </div>
        <div class="step-line" [class.active]="step >= 3"></div>
        <div class="step-dot" [class.active]="step >= 3">
          <span>3</span>
        </div>
      </div>

      <!-- Error Message -->
      <div class="error-banner" *ngIf="errorMsg">
        <i class="fas fa-exclamation-triangle"></i> {{ errorMsg }}
      </div>

      <!-- ===== STEP 1: Enter Email ===== -->
      <div *ngIf="step === 1">
        <div class="form-group">
          <label class="wow-label">
            <i class="fas fa-envelope"></i> Email Address
          </label>
          <input
            class="wow-input"
            type="email"
            [(ngModel)]="email"
            placeholder="Enter your registered email"
            (keyup.enter)="verifyEmail()"
            [disabled]="isLoading"
          />
        </div>
        <button class="btn-wow btn-wow-primary forgot-btn" (click)="verifyEmail()" [disabled]="isLoading">
          <i class="fas fa-paper-plane" *ngIf="!isLoading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
          {{ isLoading ? 'Sending OTP...' : 'Send OTP' }}
        </button>
      </div>

      <!-- ===== STEP 2: OTP or Security Question ===== -->
      <div *ngIf="step === 2">
        <div class="info-banner">
          <i class="fas fa-shield-alt"></i>
          Verify your identity for <strong>{{ email }}</strong>
        </div>

        <!-- Toggle between OTP and Security Question -->
        <div class="verify-toggle" *ngIf="securityQuestion">
          <button class="toggle-btn" [class.active]="verifyMethod === 'otp'" (click)="switchToOtp()">
            <i class="fas fa-envelope-open-text"></i> Email OTP
          </button>
          <button class="toggle-btn" [class.active]="verifyMethod === 'security'" (click)="switchToSecurity()">
            <i class="fas fa-shield-alt"></i> Security Question
          </button>
        </div>

        <!-- OTP Verification -->
        <div *ngIf="verifyMethod === 'otp'">
          <div class="otp-info">
            <i class="fas fa-info-circle"></i> A 6-digit OTP has been sent to your email. Check your inbox (and spam folder).
          </div>
          <div class="form-group">
            <label class="wow-label">
              <i class="fas fa-key"></i> Enter OTP
            </label>
            <input
              class="wow-input otp-input"
              type="text"
              [(ngModel)]="otp"
              placeholder="Enter 6-digit OTP"
              maxlength="6"
              (keyup.enter)="verifyOtp()"
              [disabled]="isLoading"
            />
          </div>
          <button class="btn-wow btn-wow-primary forgot-btn" (click)="verifyOtp()" [disabled]="isLoading">
            <i class="fas fa-check-circle" *ngIf="!isLoading"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
            {{ isLoading ? 'Verifying...' : 'Verify OTP' }}
          </button>
        </div>

        <!-- Security Question + DOB Verification -->
        <div *ngIf="verifyMethod === 'security'">
          <div class="form-group" *ngIf="securityQuestion">
            <label class="wow-label">
              <i class="fas fa-question-circle"></i> Security Question
            </label>
            <div class="security-question-display">
              {{ securityQuestion }}
            </div>
            <input
              class="wow-input"
              type="text"
              [(ngModel)]="securityAnswer"
              placeholder="Enter your answer"
              [disabled]="isLoading"
            />
          </div>

          <div class="form-group">
            <label class="wow-label">
              <i class="fas fa-calendar-alt"></i> Date of Birth
            </label>
            <input
              class="wow-input"
              type="date"
              [(ngModel)]="dob"
              (keyup.enter)="verifyIdentity()"
              [disabled]="isLoading"
            />
          </div>

          <button class="btn-wow btn-wow-primary forgot-btn" (click)="verifyIdentity()" [disabled]="isLoading">
            <i class="fas fa-check-circle" *ngIf="!isLoading"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
            {{ isLoading ? 'Verifying...' : 'Verify Identity' }}
          </button>
        </div>
      </div>

      <!-- ===== STEP 3: New Password ===== -->
      <div *ngIf="step === 3">
        <div class="success-banner">
          <i class="fas fa-check-circle"></i> Identity verified! Set your new password below.
        </div>

        <div class="form-group">
          <label class="wow-label">
            <i class="fas fa-lock"></i> New Password
          </label>
          <input
            class="wow-input"
            type="password"
            [(ngModel)]="newPassword"
            placeholder="Create a new password"
            (ngModelChange)="checkPasswordPolicy($event)"
          />
        </div>

        <!-- Password Policy Checklist -->
        <div class="password-policy" *ngIf="showPasswordPolicy">
          <div class="policy-header">
            <i class="fas fa-shield-alt"></i> Password Requirements
          </div>
          <div class="strength-bar-container">
            <div class="strength-bar">
              <div class="strength-fill" [style.width]="(passwordStrength / 5 * 100) + '%'" [style.background]="getStrengthColor()"></div>
            </div>
            <span class="strength-label" [style.color]="getStrengthColor()">{{ getStrengthLabel() }}</span>
          </div>
          <div class="policy-items">
            <div class="policy-item" [class.met]="passwordPolicy.minLength">
              <i [class]="passwordPolicy.minLength ? 'fas fa-check-circle' : 'far fa-circle'"></i> At least 8 characters
            </div>
            <div class="policy-item" [class.met]="passwordPolicy.hasUppercase">
              <i [class]="passwordPolicy.hasUppercase ? 'fas fa-check-circle' : 'far fa-circle'"></i> One uppercase letter
            </div>
            <div class="policy-item" [class.met]="passwordPolicy.hasLowercase">
              <i [class]="passwordPolicy.hasLowercase ? 'fas fa-check-circle' : 'far fa-circle'"></i> One lowercase letter
            </div>
            <div class="policy-item" [class.met]="passwordPolicy.hasNumber">
              <i [class]="passwordPolicy.hasNumber ? 'fas fa-check-circle' : 'far fa-circle'"></i> One number
            </div>
            <div class="policy-item" [class.met]="passwordPolicy.hasSpecial">
              <i [class]="passwordPolicy.hasSpecial ? 'fas fa-check-circle' : 'far fa-circle'"></i> One special character
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="wow-label">
            <i class="fas fa-lock"></i> Confirm New Password
          </label>
          <input
            class="wow-input"
            type="password"
            [(ngModel)]="confirmPassword"
            placeholder="Confirm your new password"
            (keyup.enter)="resetPassword()"
          />
        </div>

        <button class="btn-wow btn-wow-primary forgot-btn" (click)="resetPassword()" [disabled]="isLoading">
          <i class="fas fa-key" *ngIf="!isLoading"></i>
          <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
          {{ isLoading ? 'Resetting...' : 'Reset Password' }}
        </button>
      </div>

      <!-- Footer -->
      <div class="forgot-footer">
        <a (click)="goBack()" class="back-link"><i class="fas fa-arrow-left"></i> Back</a>
        <p *ngIf="step === 1">Remember your password? <a routerLink="/login" class="login-link">Login</a></p>
      </div>
    </div>
  </div>
</section>
